<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Monitoring Aktivitas | ION Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root { --bg-color: #f4f7f6; --card-bg: #ffffff; --text-main: #2c3e50; --text-muted: #7f8c8d; --border-color: #e2e8f0; --primary: #3b82f6; --danger: #ef4444; }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', Arial, sans-serif; }
    body { background: var(--bg-color); color: var(--text-main); -webkit-tap-highlight-color: transparent; }
    
    /* HEADER STICKY */
    .app-header {
      position: sticky; top: 0; z-index: 100; background: white;
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .header-btn {
      width: 40px; height: 40px; background: #f8fafc; border-radius: 10px; display: flex; justify-content: center; align-items: center;
      font-size: 1.2rem; color: var(--text-main); cursor: pointer; border: 1px solid var(--border-color);
    }
    .header-title { font-size: 1.1rem; font-weight: 800; color: #db2777; display:flex; gap:8px; align-items:center;}
    
    .container { padding: 20px 15px; max-width: 600px; margin: 0 auto; }
    
    /* FILTER BOX */
    .filter-box { background: white; padding: 18px; border-radius: 16px; margin-bottom: 20px; border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
    .filter-box label { font-size: 0.85rem; font-weight: 700; color: #475569; display:block; margin-bottom:8px;}
    .select-modern { width: 100%; padding: 14px 16px; border: 1px solid #cbd5e1; border-radius: 12px; font-size: 0.95rem; background: #f8fafc; color: #1e293b; outline: none; transition: 0.3s; }
    .select-modern:focus { border-color: #db2777; box-shadow: 0 0 0 3px rgba(219,39,119,0.15); background: white; }

    /* TAB NAVIGASI */
    .tab-nav { display: flex; background: white; border-radius: 14px; padding: 5px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
    .tab-btn { flex: 1; text-align: center; padding: 12px; border-radius: 10px; font-weight: 700; font-size: 0.9rem; color: #64748b; cursor: pointer; transition: 0.3s; }
    .tab-btn.active { background: #fdf2f8; color: #db2777; }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.4s; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }

    /* KARTU AKTIVITAS (PELANGGAN) */
    .activity-card { background: white; padding: 18px; border-radius: 16px; margin-bottom: 15px; border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
    .act-header { display: flex; justify-content: space-between; border-bottom: 2px dashed var(--border-color); padding-bottom: 12px; margin-bottom: 12px; }
    .act-title { font-weight: 800; color: #1e293b; font-size: 1.05rem; }
    .act-cid { font-size: 0.8rem; color: var(--text-muted); font-weight: 600; }
    .act-type { background: #eff6ff; color: var(--primary); padding: 5px 10px; border-radius: 8px; font-weight: 800; font-size: 0.75rem; text-transform:uppercase; letter-spacing:0.5px;}
    .act-data { display: grid; gap: 6px; font-size: 0.85rem; color: #475569; margin-bottom: 15px;}
    .act-data div { display: flex; gap: 8px; align-items:flex-start;}
    .act-data i { color: #db2777; width: 15px; margin-top: 3px;}
    
    /* TOMBOL ACTION SIMETRIS */
    .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn { padding: 12px; border-radius: 10px; border: none; font-weight: 700; font-size: 0.85rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 6px; transition: 0.2s; }
    .btn:active { transform: translateY(2px); }
    .btn-edit { background: #eff6ff; color: var(--primary); border: 1px dashed var(--primary); }
    .btn-del { background: #fef2f2; color: var(--danger); border: 1px dashed var(--danger); }

    /* LOADER */
    .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; transition: 0.4s; }
    .loader-overlay.hidden { opacity: 0; visibility: hidden; }

    /* SWEETALERT CUSTOM FORM */
    .swal-custom-form { text-align: left; margin-top: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px; }
    .swal-custom-form .form-group { margin-bottom: 12px; }
    .swal-custom-form label { display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;}
    .swal-custom-form input, .swal-custom-form select { width: 100%; padding: 12px 14px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 0.9rem; background: #f8fafc; outline: none; transition: 0.3s; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif;}
    .swal-custom-form input:focus, .swal-custom-form select:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15); }
    .swal-custom-form .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  </style>
</head>
<body>

  <div class="loader-overlay" id="loader">
    <i class="fas fa-desktop fa-beat" style="font-size: 3rem; color: #db2777; margin-bottom: 15px;"></i>
    <p style="font-weight: 600;">Memuat Riwayat Sistem...</p>
  </div>

  <header class="app-header">
    <div class="header-btn" onclick="window.location.href='index.html'"><i class="fas fa-arrow-left"></i></div>
    <div class="header-title"><i class="fas fa-desktop"></i> Monitoring</div>
    <div class="header-btn" onclick="location.reload()"><i class="fas fa-sync-alt" style="color: #db2777;"></i></div>
  </header>

  <div class="container">
    
    <div class="filter-box">
        <label>üîç Pantau Aktivitas Dari:</label>
        <select id="userFilter" class="select-modern" onchange="renderData()">
            <option value="">-- Pilih Admin / Teknisi --</option>
            <option value="ALL">üåü SEMUA TIM</option>
        </select>
    </div>

    <div class="tab-nav">
        <div class="tab-btn active" id="btnTabPelanggan" onclick="switchTab('Pelanggan')">Laporan Pelanggan (<span id="countPelanggan">0</span>)</div>
        <div class="tab-btn" id="btnTabOdp" onclick="switchTab('Odp')">Pembuat ODP (<span id="countOdp">0</span>)</div>
    </div>

    <div id="tabPelanggan" class="tab-content active">
        <div id="listPelanggan"></div>
    </div>

    <div id="tabOdp" class="tab-content">
        <div id="listOdp"></div>
    </div>

  </div>

  <script>
    // ‚ö†Ô∏è GANTI DENGAN URL WEB APP V6 ANDA (SAMA SEPERTI DI INDEX.HTML)
    const API_URL = "https://script.google.com/macros/s/AKfycbw12NOapHRmUvNqSzs4Oj_OTFkX2SSHTNaufp1pGPYNoKlvnxZ9DfjkLjk0RvrF4vTtOQ/exec";
    
    let currentUser = JSON.parse(localStorage.getItem('ionUser'));
    let masterData = {};

    window.onload = async () => {
      // Keamanan Khusus Admin
      if (!currentUser || currentUser.role !== 'Admin') {
          alert('Akses Ditolak! Fitur ini hanya untuk Admin.');
          window.location.href = "index.html";
          return;
      }
      
      try {
        let res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getData" }) }).then(r=>r.json());
        if (res.ok) {
          masterData = res.data;
          // Urutkan Pelanggan dari yang terbaru ke terlama (Dibalik)
          masterData.pelanggan.reverse();
          masterData.odp.reverse();
          
          populateUserFilter();
          document.getElementById('loader').classList.add('hidden');
        } else { Swal.fire('Error', res.message, 'error'); }
      } catch (e) { Swal.fire('Error', 'Gagal memuat riwayat data', 'error'); }
    };

    function populateUserFilter() {
        let opts = '<option value="">-- Pilih Admin / Teknisi --</option><option value="ALL">üåü Tampilkan Semua Data</option>';
        // Ambil semua nama member yang ada
        masterData.member.forEach(r => opts += `<option value="${r[0]}">${r[0]}</option>`);
        document.getElementById('userFilter').innerHTML = opts;
        renderData(); // Panggil render pertama kali walau kosong
    }

    function switchTab(tabName) {
        document.getElementById('btnTabPelanggan').classList.remove('active');
        document.getElementById('btnTabOdp').classList.remove('active');
        document.getElementById('tabPelanggan').classList.remove('active');
        document.getElementById('tabOdp').classList.remove('active');

        document.getElementById('btnTab' + tabName).classList.add('active');
        document.getElementById('tab' + tabName).classList.add('active');
    }

    // --- RENDER SEMUA AKTIVITAS ---
    function renderData() {
        let selectedUser = document.getElementById('userFilter').value;
        if (!selectedUser) {
            document.getElementById('listPelanggan').innerHTML = "<p style='text-align:center; color:#94a3b8; margin-top:30px;'>Pilih nama teknisi di atas untuk melihat riwayatnya.</p>";
            document.getElementById('listOdp').innerHTML = "<p style='text-align:center; color:#94a3b8; margin-top:30px;'>Pilih nama teknisi di atas untuk melihat riwayatnya.</p>";
            return;
        }

        // 1. Render Pelanggan (Laporan)
        // Schema: 0:Tgl, 1:Jenis, 2:Nama, 3:CID, 4:OLT, 5:ODP, 6:Port, 7:Teknisi, 8:Ket, 9:Email, 10:Perangkat, 11:SN
        let pelHTML = ""; let countPel = 0;
        masterData.pelanggan.forEach(p => {
            if (selectedUser === "ALL" || p[7] === selectedUser) {
                countPel++;
                let rawData = encodeURIComponent(JSON.stringify(p));
                pelHTML += `
                <div class="activity-card">
                    <div class="act-header">
                        <div>
                            <div class="act-title">${p[2]}</div>
                            <div class="act-cid">CID: ${p[3]}</div>
                        </div>
                        <div class="act-type">${p[1]}</div>
                    </div>
                    <div class="act-data">
                        <div><i class="far fa-clock"></i> <span>Dikerjakan: <strong>${p[0].substring(0, 16)}</strong></span></div>
                        <div><i class="fas fa-user-hard-hat"></i> <span>Teknisi: <strong>${p[7]}</strong></span></div>
                        <div><i class="fas fa-network-wired"></i> <span>Lokasi: <strong>${p[5]} (Port ${p[6]})</strong></span></div>
                        <div><i class="fas fa-router"></i> <span>SN Perangkat: <strong>${p[11]}</strong></span></div>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-edit" onclick="editLaporan('${rawData}')"><i class="fas fa-edit"></i> Edit Koreksi</button>
                        <button class="btn btn-del" onclick="deleteLaporan('${p[3]}')"><i class="fas fa-trash"></i> Hapus Laporan</button>
                    </div>
                </div>`;
            }
        });
        document.getElementById('listPelanggan').innerHTML = pelHTML || "<p style='text-align:center; color:#94a3b8;'>Belum ada laporan dari user ini.</p>";
        document.getElementById('countPelanggan').innerText = countPel;

        // 2. Render ODP Pembuatan
        // Schema ODP: 0:Nama, 1:Kode, 2:OLT, 3:PON, 4:Card, 5:Tikor, 6:Link, 7:Core, 8:Team, 9:Tgl Input, 10:User, 11:Max, 12:Terpakai
        let odpHTML = ""; let countO = 0;
        masterData.odp.forEach(o => {
            if (selectedUser === "ALL" || o[10] === selectedUser) {
                countO++;
                odpHTML += `
                <div class="activity-card">
                    <div class="act-header">
                        <div>
                            <div class="act-title">${o[0]}</div>
                            <div class="act-cid">OLT Induk: ${o[2]}</div>
                        </div>
                        <div class="act-type" style="background:#fce7f3; color:#db2777;">BUAT ODP BARU</div>
                    </div>
                    <div class="act-data">
                        <div><i class="far fa-clock"></i> <span>Tgl Dibuat: <strong>${o[9]}</strong></span></div>
                        <div><i class="fas fa-user-plus"></i> <span>Pembuat: <strong>${o[10]}</strong></span></div>
                        <div><i class="fas fa-server"></i> <span>Max Port: <strong>${o[11]}</strong></span></div>
                    </div>
                    <div class="action-btns">
                        <button class="btn btn-del" style="grid-column: span 2;" onclick="deleteOdp('${o[0]}')"><i class="fas fa-trash"></i> Hapus Permanen ODP Ini</button>
                    </div>
                </div>`;
            }
        });
        document.getElementById('listOdp').innerHTML = odpHTML || "<p style='text-align:center; color:#94a3b8;'>Belum pernah buat ODP.</p>";
        document.getElementById('countOdp').innerText = countO;
    }

    // =====================================
    // FUNGSI ADMIN: HAPUS LAPORAN
    // =====================================
    async function deleteLaporan(cid) {
        if(!await Swal.fire({title: 'Hapus Laporan?', text: 'Data laporan ini akan musnah dan port kembali kosong.', icon: 'warning', showCancelButton: true}).then(r=>r.isConfirmed)) return;
        document.getElementById('loader').classList.remove('hidden');
        try {
            let res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "crud", payload: { sheetName: "Data_Pelanggan", mode: "delete", oldKey: cid }}) }).then(r=>r.json());
            if(res.ok) { Swal.fire('Terhapus', res.message, 'success'); setTimeout(() => location.reload(), 1000); } 
            else { Swal.fire('Error', res.message, 'error'); document.getElementById('loader').classList.add('hidden'); }
        } catch(e) { Swal.fire('Error', 'Koneksi gagal', 'error'); document.getElementById('loader').classList.add('hidden');}
    }

    // =====================================
    // FUNGSI ADMIN: HAPUS ODP
    // =====================================
    async function deleteOdp(namaOdp) {
        if(!await Swal.fire({title: 'HAPUS ODP INI?', text: 'PERINGATAN! Semua pelanggan yang ada di dalam ODP ini juga akan ikut terhapus bersih!', icon: 'error', showCancelButton: true, confirmButtonColor: '#ef4444'}).then(r=>r.isConfirmed)) return;
        document.getElementById('loader').classList.remove('hidden');
        try {
            let res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "crud", payload: { sheetName: "odp", mode: "delete", oldKey: namaOdp }}) }).then(r=>r.json());
            if(res.ok) { Swal.fire('ODP Dihancurkan', res.message, 'success'); setTimeout(() => location.reload(), 1500); } 
            else { Swal.fire('Error', res.message, 'error'); document.getElementById('loader').classList.add('hidden'); }
        } catch(e) { Swal.fire('Error', 'Koneksi gagal', 'error'); document.getElementById('loader').classList.add('hidden');}
    }

    // =====================================
    // FUNGSI ADMIN: EDIT KOREKSI LAPORAN (SWEETALERT LENGKAP)
    // =====================================
    async function editLaporan(encodedData) {
        let c = JSON.parse(decodeURIComponent(encodedData));
        // Schema: 0:Tgl, 1:Jenis, 2:Nama, 3:CID, 4:OLT, 5:ODP, 6:Port, 7:Teknisi, 8:Ket, 9:Email, 10:Perangkat, 11:SN
        let oldCid = c[3]; 
        let initialOdp = c[5]; 

        const { value: formValues } = await Swal.fire({
            title: '<h3 style="margin:0; font-size:1.1rem; color:#db2777;"><i class="fas fa-edit"></i> Koreksi Data Laporan</h3>',
            html: `
                <div class="swal-custom-form">
                    <div class="form-grid">
                        <div class="form-group"><label>Nama Pelanggan</label><input id="swal-nama" value="${c[2]}"></div>
                        <div class="form-group"><label>Nomor CID</label><input id="swal-cid" type="number" value="${c[3]}"></div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group"><label>Pilih OLT Induk</label><select id="swal-olt" onchange="updateSwalOdp()"></select></div>
                        <div class="form-group"><label>Pilih ODP Tujuan</label><select id="swal-odp"></select></div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group"><label>Port Tujuan</label><input id="swal-port" type="number" value="${c[6]}"></div>
                        <div class="form-group"><label>Jenis Perangkat</label><select id="swal-perangkat">
                                <option value="">-- Pilih --</option>
                                <option value="C-DATA XPON ONU">C-DATA XPON ONU</option>
                                <option value="C-DATA XPON DUAL-BAND ONU">C-DATA XPON DUAL-BAND ONU</option>
                                <option value="RISECOME">RISECOME</option>
                                <option value="RISECOME (DISMANTLE)">RISECOME (DISMANTLE)</option>
                                <option value="C-DATA XPON ONU (DISMANTLE)">C-DATA XPON ONU (DISMANTLE)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group"><label>SN Perangkat</label><input id="swal-sn" value="${c[11]}"></div>
                        <div class="form-group"><label>Nama Teknisi</label><input id="swal-teknisi" value="${c[7]}"></div>
                    </div>
                </div>
            `,
            width: '90%', focusConfirm: false, showCancelButton: true, confirmButtonColor: '#3b82f6', cancelButtonColor: '#e2e8f0', confirmButtonText: 'Simpan Koreksi', cancelButtonText: '<span style="color:#475569">Batal</span>',
            didOpen: () => {
                let oltSelect = document.getElementById('swal-olt');
                let odpSelect = document.getElementById('swal-odp');
                document.getElementById('swal-perangkat').value = c[10] || "";

                let oltOpts = '<option value="">-- Pilih OLT --</option>';
                masterData.olt.forEach(r => { let sel = (r[0] === c[4]) ? 'selected' : ''; oltOpts += `<option value="${r[0]}" ${sel}>${r[0]}</option>`; });
                oltSelect.innerHTML = oltOpts;

                window.updateSwalOdp = function() {
                    let selectedOlt = oltSelect.value;
                    let odpOpts = '<option value="">-- Pilih ODP --</option>';
                    masterData.odp.forEach(r => {
                        if (r[2] === selectedOlt) {
                            let sel = (r[0] === initialOdp) ? 'selected' : ''; 
                            odpOpts += `<option value="${r[0]}" ${sel}>${r[0]}</option>`;
                        }
                    });
                    odpSelect.innerHTML = odpOpts;
                    initialOdp = ""; 
                };
                window.updateSwalOdp();
            },
            preConfirm: () => {
                return {
                    nama: document.getElementById('swal-nama').value, cid: document.getElementById('swal-cid').value,
                    olt: document.getElementById('swal-olt').value, odp: document.getElementById('swal-odp').value,
                    port: document.getElementById('swal-port').value, perangkat: document.getElementById('swal-perangkat').value,
                    sn: document.getElementById('swal-sn').value, teknisi: document.getElementById('swal-teknisi').value
                }
            }
        });

        if (formValues) {
            if (!formValues.nama || !formValues.cid || !formValues.olt || !formValues.odp) return Swal.fire('Gagal', 'Nama, CID, OLT, dan ODP wajib diisi!', 'error');

            document.getElementById('loader').classList.remove('hidden');
            
            c[2] = formValues.nama; c[3] = formValues.cid; c[4] = formValues.olt; c[5] = formValues.odp; c[6] = formValues.port; 
            c[7] = formValues.teknisi; c[10] = formValues.perangkat; c[11] = formValues.sn;
            
            try {
                let res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "crud", payload: { sheetName: "Data_Pelanggan", mode: "edit", dataRow: c, oldKey: oldCid }}) }).then(r=>r.json());
                if(res.ok) { Swal.fire('Terkoreksi', 'Data berhasil diperbaiki!', 'success'); setTimeout(() => location.reload(), 1000); } 
                else { Swal.fire('Error', res.message, 'error'); document.getElementById('loader').classList.add('hidden');}
            } catch(e) { Swal.fire('Error', 'Koneksi gagal', 'error'); document.getElementById('loader').classList.add('hidden');}
        }
    }
  </script>
</body>
</html>