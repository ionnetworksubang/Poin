<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ODP Manajemen | ION Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root { 
      --bg-color: #f4f7f6; 
      --card-bg: #ffffff; 
      --text-main: #2c3e50; 
      --text-muted: #7f8c8d; 
      --border-color: #e2e8f0; 
      --primary: #3498db; 
      --danger: #ef4444;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', Arial, sans-serif; }
    body { background: var(--bg-color); color: var(--text-main); -webkit-tap-highlight-color: transparent; }
    
    /* HEADER STICKY */
    .app-header {
      position: sticky; top: 0; z-index: 100;
      background: white;
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .header-btn {
      width: 40px; height: 40px; background: #f8fafc; border-radius: 10px;
      display: flex; justify-content: center; align-items: center;
      font-size: 1.2rem; color: var(--text-main); cursor: pointer; border: 1px solid var(--border-color);
    }
    .header-title { font-size: 1.1rem; font-weight: 700; color: #1e293b; }
    
    .container { padding: 20px 15px; max-width: 600px; margin: 0 auto; }
    
    /* PENCARIAN & FILTER */
    .filter-group { margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
    .search-box { 
      width: 100%; padding: 14px 16px; border-radius: 12px; border: 1px solid #cbd5e1; 
      font-size: 0.95rem; background: #f8fafc; outline: none; transition: 0.3s;
    }
    .search-box:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15); }
    
    /* KARTU ODP (TAMPILAN DEPAN) */
    .odp-card { 
      background: white; padding: 18px; border-radius: 16px; margin-bottom: 15px; 
      border: 1px solid var(--border-color); display: flex; justify-content: space-between; 
      align-items: center; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.03); transition: 0.2s; 
    }
    .odp-card:active { transform: scale(0.98); background: #f8fafc; }
    .odp-title { font-weight: 800; color: #1e293b; margin-bottom: 6px; font-size: 1.05rem; }
    .odp-subtitle { font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px;}
    .badge-count { background: #eff6ff; color: var(--primary); padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 0.75rem; }

    /* KARTU CLIENT (TAMPILAN ISI ODP) */
    .client-card { 
      background: white; padding: 20px; border-radius: 16px; margin-bottom: 15px; 
      border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.04); 
    }
    .client-header { 
      display: flex; justify-content: space-between; align-items: flex-start; 
      border-bottom: 2px dashed var(--border-color); padding-bottom: 12px; margin-bottom: 12px; 
    }
    .client-name { font-weight: 800; color: #1e293b; font-size: 1.05rem; line-height: 1.3; }
    .client-cid { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; margin-top: 3px; }
    .port-badge { 
      background: #f0fdfa; color: #0d9488; border: 1px solid #ccfbf1;
      padding: 6px 12px; border-radius: 10px; font-weight: 800; font-size: 0.85rem; white-space: nowrap;
    }
    
    .client-data { display: grid; grid-template-columns: 1fr; gap: 8px; margin-bottom: 15px; }
    .data-row { display: flex; align-items: center; gap: 10px; font-size: 0.85rem; color: #475569; }
    .data-row i { color: var(--primary); width: 16px; text-align: center; }
    .data-row strong { color: #1e293b; font-weight: 600; }

    /* TOMBOL ACTION SIMETRIS */
    .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn { 
      padding: 12px; border-radius: 10px; border: none; font-weight: 700; font-size: 0.85rem; 
      cursor: pointer; color: white; display: flex; justify-content: center; align-items: center; gap: 6px; transition: 0.2s;
    }
    .btn:active { transform: translateY(2px); }
    .btn-edit { background: #eff6ff; color: var(--primary); border: 1px solid #bfdbfe; }
    .btn-del { background: #fef2f2; color: var(--danger); border: 1px solid #fecdd3; }

    /* --- CUSTOM CSS UNTUK FORM SWEETALERT ALL-DATA --- */
    .swal-custom-form { text-align: left; margin-top: 10px; max-height: 60vh; overflow-y: auto; padding-right: 5px; }
    .swal-custom-form::-webkit-scrollbar { width: 6px; }
    .swal-custom-form::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .swal-custom-form .form-group { margin-bottom: 12px; }
    .swal-custom-form .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .swal-custom-form label { display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;}
    .swal-custom-form input, .swal-custom-form select { 
      width: 100%; padding: 12px 14px; border: 1px solid #cbd5e1; border-radius: 10px; 
      font-size: 0.9rem; background: #f8fafc; outline: none; transition: 0.3s; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif;
    }
    .swal-custom-form input:focus, .swal-custom-form select:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15); }
    
    .hidden { display: none !important; }

    /* LOADER */
    .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; transition: 0.4s; }
    .loader-overlay.hidden { opacity: 0; visibility: hidden; }
  </style>
</head>
<body>

  <div class="loader-overlay" id="loader">
    <i class="fas fa-circle-notch fa-spin" style="font-size: 3rem; color: #3498db; margin-bottom: 15px;"></i>
    <p style="font-weight: 600;">Memuat Database Pelanggan...</p>
  </div>

  <header class="app-header">
    <div class="header-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></div>
    <div class="header-title" id="pageTitle">ODP Manajemen</div>
    <div class="header-btn" onclick="location.reload()"><i class="fas fa-sync-alt" style="color: #3498db;"></i></div>
  </header>

  <div class="container" id="viewOdpList">
    <div class="filter-group">
        <input type="text" class="search-box" id="searchOdp" placeholder="Cari Nama ODP..." oninput="renderOdpList()">
        <select class="search-box" id="filterOlt" onchange="renderOdpList()">
            <option value="">Semua OLT Induk</option>
        </select>
    </div>
    <div id="listOdp"></div>
  </div>

  <div class="container hidden" id="viewClientList">
    <h3 style="margin-bottom: 15px; color: #1e293b; font-size: 1.1rem;" id="detailOdpName">Isi ODP</h3>
    <div id="listClient"></div>
  </div>

  <script>
    // ⚠️ GANTI DENGAN URL WEB APP V6 ANDA
    const API_URL = "https://script.google.com/macros/s/AKfycbw12NOapHRmUvNqSzs4Oj_OTFkX2SSHTNaufp1pGPYNoKlvnxZ9DfjkLjk0RvrF4vTtOQ/exec";
    
    let currentUser = JSON.parse(localStorage.getItem('ionUser'));
    let masterData = {};
    let activeOdp = "";

    window.onload = async () => {
      if (!currentUser) return window.location.href = "index.html";
      try {
        let res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getData" }) }).then(r=>r.json());
        if (res.ok) {
          masterData = res.data;
          populateOltFilter();
          renderOdpList();
          document.getElementById('loader').classList.add('hidden');
        } else { Swal.fire('Error', res.message, 'error'); }
      } catch (e) { Swal.fire('Koneksi Error', 'Gagal memuat data', 'error'); }
    };

    function goBack() {
        if (!document.getElementById('viewClientList').classList.contains('hidden')) {
            document.getElementById('viewClientList').classList.add('hidden');
            document.getElementById('viewOdpList').classList.remove('hidden');
            document.getElementById('pageTitle').innerText = "ODP Manajemen";
            renderOdpList(); 
        } else {
            window.location.href = "index.html";
        }
    }

    function populateOltFilter() {
        let opts = '<option value="">Semua OLT Induk</option>';
        masterData.olt.forEach(r => opts += `<option value="${r[0]}">${r[0]}</option>`);
        document.getElementById('filterOlt').innerHTML = opts;
    }

    function renderOdpList() {
        let q = document.getElementById('searchOdp').value.toLowerCase();
        let f = document.getElementById('filterOlt').value;
        let html = "";
        let count = 0;

        masterData.odp.forEach(row => {
            let namaOdp = row[0], olt = row[2], maxPort = row[11];
            let usedCount = (masterData.usedPorts[namaOdp] || []).length;

            if ((namaOdp.toLowerCase().includes(q)) && (f === "" || olt === f)) {
                count++;
                html += `
                <div class="odp-card" onclick="openOdpDetail('${namaOdp}')">
                    <div>
                        <div class="odp-title">${namaOdp}</div>
                        <div class="odp-subtitle"><i class="fas fa-server"></i> ${olt}</div>
                    </div>
                    <div class="badge-count">${usedCount}/${maxPort} Port</div>
                </div>`;
            }
        });
        
        if(count === 0) html = "<p style='text-align:center; color:#94a3b8; margin-top:30px;'>Tidak ada ODP ditemukan.</p>";
        document.getElementById('listOdp').innerHTML = html;
    }

    function openOdpDetail(namaOdp) {
        activeOdp = namaOdp;
        document.getElementById('pageTitle').innerText = "Detail ODP";
        document.getElementById('detailOdpName').innerHTML = `<i class="fas fa-box-open" style="color:#3498db;"></i> Pelanggan di ${namaOdp}`;
        document.getElementById('viewOdpList').classList.add('hidden');
        document.getElementById('viewClientList').classList.remove('hidden');

        let clients = masterData.pelanggan.filter(p => p[5] === namaOdp);
        clients.sort((a, b) => parseInt(a[6]) - parseInt(b[6]));

        let html = "";
        if (clients.length === 0) html = "<div style='text-align:center; color:#94a3b8; margin-top:40px; padding:20px; border:2px dashed #cbd5e1; border-radius:16px;'><i class='fas fa-wind' style='font-size:3rem; margin-bottom:15px; color:#e2e8f0;'></i><br>ODP ini masih kosong.</div>";

        clients.forEach(c => {
            // Index: 0:Tgl, 1:Jenis, 2:Nama, 3:CID, 4:OLT, 5:ODP, 6:Port, 7:Teknisi, 8:Ket, 9:Email, 10:Perangkat, 11:SN
            let adminBtns = "";
            if(currentUser.role === 'Admin') {
                // Aman dari tanda kutip
                let rawData = encodeURIComponent(JSON.stringify(c));
                adminBtns = `
                <div class="action-btns">
                    <button class="btn btn-edit" onclick="editClient('${rawData}')"><i class="fas fa-edit"></i> Edit Lengkap</button>
                    <button class="btn btn-del" onclick="deleteClient('${c[3]}')"><i class="fas fa-trash"></i> Hapus</button>
                </div>`;
            }

            html += `
            <div class="client-card">
                <div class="client-header">
                    <div>
                        <div class="client-name">${c[2]}</div>
                        <div class="client-cid">CID: ${c[3]}</div>
                    </div>
                    <div class="port-badge">Port ${c[6]}</div>
                </div>
                <div class="client-data">
                    <div class="data-row"><i class="fas fa-envelope"></i> <span>${c[9] || '-'}</span></div>
                    <div class="data-row"><i class="fas fa-router"></i> <span>${c[10] || '-'} <br><small>SN: <strong>${c[11] || '-'}</strong></small></span></div>
                    <div class="data-row"><i class="fas fa-user-hard-hat"></i> <span>Input oleh: <strong>${c[7]}</strong></span></div>
                    <div class="data-row"><i class="far fa-clock"></i> <span>${c[0].substring(0, 10)}</span></div>
                </div>
                ${adminBtns}
            </div>`;
        });
        document.getElementById('listClient').innerHTML = html;
    }

    async function deleteClient(cid) {
        if(!await Swal.fire({title: 'Hapus Pelanggan?', text: 'Data laporan pelanggan akan dihapus dan Port kembali kosong.', icon: 'warning', showCancelButton: true}).then(r=>r.isConfirmed)) return;
        
        document.getElementById('loader').classList.remove('hidden');
        try {
            let res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "crud", payload: { sheetName: "Data_Pelanggan", mode: "delete", oldKey: cid }}) }).then(r=>r.json());
            if(res.ok) {
                Swal.fire('Terhapus', res.message, 'success');
                setTimeout(() => location.reload(), 1000); 
            } else { Swal.fire('Error', res.message, 'error'); document.getElementById('loader').classList.add('hidden'); }
        } catch(e) { Swal.fire('Error', 'Koneksi gagal', 'error'); document.getElementById('loader').classList.add('hidden');}
    }

    // --- FUNGSI EDIT ALL DATA LENGKAP ---
    async function editClient(encodedData) {
        let c = JSON.parse(decodeURIComponent(encodedData));
        // c = [0:Tgl, 1:Jenis, 2:Nama, 3:CID, 4:OLT, 5:ODP, 6:Port, 7:Teknisi, 8:Ket, 9:Email, 10:Perangkat, 11:SN]
        
        let oldCid = c[3]; // SIMPAN CID LAMA SEBAGAI KUNCI UPDATE
        let initialOdp = c[5]; // SIMPAN ODP LAMA

        const { value: formValues } = await Swal.fire({
            title: '<h3 style="margin:0; font-size:1.2rem; color:#1e293b;">Edit Data Pelanggan</h3>',
            html: `
                <div class="swal-custom-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nama Pelanggan</label>
                            <input id="swal-nama" value="${c[2]}" placeholder="Nama lengkap">
                        </div>
                        <div class="form-group">
                            <label>Nomor CID</label>
                            <input id="swal-cid" type="number" value="${c[3]}" placeholder="CID">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Email Pelanggan</label>
                        <input id="swal-email" type="email" value="${c[9]}" placeholder="Email (Opsional)">
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Pilih OLT Induk</label>
                            <select id="swal-olt" onchange="updateSwalOdp()"></select>
                        </div>
                        <div class="form-group">
                            <label>Pilih ODP Tujuan</label>
                            <select id="swal-odp"></select>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Port Tujuan</label>
                            <input id="swal-port" type="number" value="${c[6]}" placeholder="Angka Port">
                        </div>
                        <div class="form-group">
                            <label>Jenis Perangkat</label>
                            <select id="swal-perangkat">
                                <option value="">-- Pilih --</option>
                                <option value="C-DATA XPON ONU">C-DATA XPON ONU</option>
                                <option value="C-DATA XPON DUAL-BAND ONU">C-DATA XPON DUAL-BAND ONU</option>
                                <option value="RISECOME">RISECOME</option>
                                <option value="RISECOME (DISMANTLE)">RISECOME (DISMANTLE)</option>
                                <option value="C-DATA XPON ONU (DISMANTLE)">C-DATA XPON ONU (DISMANTLE)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>SN Perangkat</label>
                        <input id="swal-sn" value="${c[11]}" placeholder="Serial Number">
                    </div>

                    <div class="form-group">
                        <label>Keterangan Laporan</label>
                        <input id="swal-ket" value="${c[8]}" placeholder="Selesai / Catatan Khusus">
                    </div>
                </div>
            `,
            width: '90%', // Bikin modal agak lebar sedikit
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonColor: '#3498db',
            cancelButtonColor: '#e2e8f0',
            confirmButtonText: 'Simpan Perubahan',
            cancelButtonText: '<span style="color:#475569">Batal</span>',
            didOpen: () => {
                // LOGIKA AUTO-POPULATE DROPDOWN OLT & ODP SAAT MODAL TERBUKA
                let oltSelect = document.getElementById('swal-olt');
                let odpSelect = document.getElementById('swal-odp');
                let perangkatSelect = document.getElementById('swal-perangkat');

                // Set Perangkat
                perangkatSelect.value = c[10] || "";

                // Isi Dropdown OLT
                let oltOpts = '<option value="">-- Pilih OLT --</option>';
                masterData.olt.forEach(r => {
                    let sel = (r[0] === c[4]) ? 'selected' : '';
                    oltOpts += `<option value="${r[0]}" ${sel}>${r[0]}</option>`;
                });
                oltSelect.innerHTML = oltOpts;

                // Fungsi global untuk update ODP jika OLT diganti
                window.updateSwalOdp = function() {
                    let selectedOlt = oltSelect.value;
                    let odpOpts = '<option value="">-- Pilih ODP --</option>';
                    masterData.odp.forEach(r => {
                        if (r[2] === selectedOlt) {
                            let sel = (r[0] === initialOdp) ? 'selected' : ''; 
                            odpOpts += `<option value="${r[0]}" ${sel}>${r[0]}</option>`;
                        }
                    });
                    odpSelect.innerHTML = odpOpts;
                    initialOdp = ""; // Kosongkan initial agar saat pilih OLT lain tidak ngebug
                };

                // Panggil pertama kali untuk isi ODP bawaan
                window.updateSwalOdp();
            },
            preConfirm: () => {
                return {
                    nama: document.getElementById('swal-nama').value,
                    cid: document.getElementById('swal-cid').value,
                    email: document.getElementById('swal-email').value,
                    olt: document.getElementById('swal-olt').value,
                    odp: document.getElementById('swal-odp').value,
                    port: document.getElementById('swal-port').value,
                    perangkat: document.getElementById('swal-perangkat').value,
                    sn: document.getElementById('swal-sn').value,
                    ket: document.getElementById('swal-ket').value
                }
            }
        });

        if (formValues) {
            // Validasi Kosong
            if (!formValues.nama || !formValues.cid || !formValues.olt || !formValues.odp) {
                return Swal.fire('Gagal', 'Nama, CID, OLT, dan ODP wajib diisi!', 'error');
            }

            document.getElementById('loader').classList.remove('hidden');
            
            // TIMPA ARRAY LAMA DENGAN DATA BARU
            c[2] = formValues.nama;
            c[3] = formValues.cid; 
            c[4] = formValues.olt;
            c[5] = formValues.odp;
            c[6] = formValues.port;
            c[8] = formValues.ket;
            c[9] = formValues.email;
            c[10] = formValues.perangkat;
            c[11] = formValues.sn;
            
            try {
                // KIRIM KE SERVER MENGGUNAKAN oldKey = oldCid (agar barisnya tidak meleset walau CID diubah)
                let res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "crud", payload: { sheetName: "Data_Pelanggan", mode: "edit", dataRow: c, oldKey: oldCid }}) }).then(r=>r.json());
                if(res.ok) {
                    Swal.fire('Tersimpan', res.message, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else { Swal.fire('Error', res.message, 'error'); document.getElementById('loader').classList.add('hidden');}
            } catch(e) { Swal.fire('Error', 'Koneksi gagal', 'error'); document.getElementById('loader').classList.add('hidden');}
        }
    }
  </script>
</body>
</html>