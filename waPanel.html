<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Kirim WhatsApp | ION Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root { 
      --bg-color: #f0f2f5; /* Warna background khas WhatsApp Web */
      --card-bg: #ffffff; 
      --text-main: #111b21; 
      --text-muted: #667781; 
      --border-color: #d1d7db; 
      --primary: #25d366; /* Hijau WA */
      --primary-dark: #128c7e;
      --blue: #3498db;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', Arial, sans-serif; }
    body { background: var(--bg-color); color: var(--text-main); -webkit-tap-highlight-color: transparent; padding-bottom: 40px; }
    
    /* HEADER KEKINIAN */
    .app-header {
      position: sticky; top: 0; z-index: 100; background: var(--primary-dark);
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 20px; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .header-btn {
      width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
      font-size: 1.2rem; color: white; cursor: pointer; transition: 0.2s; background: rgba(255,255,255,0.1);
    }
    .header-btn:active { background: rgba(255,255,255,0.2); }
    .header-title { font-size: 1.15rem; font-weight: 700; }
    
    .container { padding: 15px; max-width: 600px; margin: 0 auto; }

    /* KONTAK SEMENTARA (BUKU TELEPON MINI) */
    .contact-tray { background: white; border-radius: 16px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .tray-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .tray-title { font-size: 0.9rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    
    .contact-list { display: flex; flex-direction: column; gap: 8px; max-height: 180px; overflow-y: auto; }
    .contact-item { 
        display: flex; justify-content: space-between; align-items: center; background: #f8fafc; 
        padding: 10px 15px; border-radius: 12px; border: 1px solid #e2e8f0; cursor: pointer; transition: 0.2s;
    }
    .contact-item:active { background: #e6f7ff; border-color: var(--blue); }
    .c-info { flex: 1; }
    .c-name { font-weight: 700; font-size: 0.95rem; color: var(--text-main); }
    .c-phone { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }
    .btn-del-contact { background: #fee2e2; color: #ef4444; border: none; width: 30px; height: 30px; border-radius: 8px; cursor: pointer; }

    /* CARD STEP-BY-STEP PANDUAN ORANG AWAM */
    .step-card {
      background: var(--card-bg); border-radius: 16px; padding: 20px;
      margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid var(--border-color);
      position: relative;
    }
    .step-badge {
      position: absolute; top: -12px; left: 20px; background: var(--blue); color: white;
      font-weight: 800; font-size: 0.9rem; padding: 4px 12px; border-radius: 20px;
      box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); border: 2px solid white;
    }
    
    .form-group { margin-bottom: 15px; margin-top: 10px; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    label { display: block; font-size: 0.85rem; font-weight: 700; color: var(--text-main); margin-bottom: 6px; }
    
    /* INPUT EMPUK */
    .input-modern {
      width: 100%; padding: 14px 16px; border: 1px solid #cbd5e1; border-radius: 12px;
      font-size: 0.95rem; background: #f8fafc; color: var(--text-main); outline: none; transition: 0.3s;
    }
    .input-modern:focus { border-color: var(--blue); background: white; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15); }
    
    /* GELEMBUNG CHAT WHATSAPP (PREVIEW) */
    .wa-chat-container { background: #efeae2; padding: 20px; border-radius: 16px; margin-top: 15px; display: none; }
    .wa-bubble {
        background: #d9fdd3; /* Warna hijau khas gelembung WA */
        padding: 12px 16px; border-radius: 8px 0px 8px 8px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        font-size: 0.9rem; line-height: 1.5; color: #111b21;
        white-space: pre-wrap; position: relative; margin-left: 20px;
    }
    .wa-bubble::after { /* Buntut gelembung chat */
        content: ''; position: absolute; top: 0; right: -8px;
        width: 0; height: 0; border-top: 10px solid #d9fdd3; border-right: 10px solid transparent;
    }

    /* TOMBOL UTAMA */
    .btn-save { 
        width: 100%; padding: 12px; background: #f1f5f9; color: var(--blue); border: 1px dashed var(--blue);
        border-radius: 12px; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 5px;
    }
    .btn-save:active { background: #e0f2fe; }

    .btn-wa { 
      width: 100%; padding: 16px; border: none; border-radius: 14px; font-weight: 800; 
      font-size: 1rem; color: white; cursor: pointer; display: flex; justify-content: center; 
      align-items: center; gap: 10px; background: var(--primary); box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3); margin-top: 15px;
    }
    .btn-wa:active { transform: scale(0.98); }

    .btn-contact-hp {
      background: white; color: var(--text-main); border: 1px solid #cbd5e1;
      padding: 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 700;
      width: 100%; cursor: pointer; margin-top: 10px; display: flex; justify-content: center; align-items: center; gap: 8px;
    }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <header class="app-header">
    <div class="header-btn" onclick="window.history.back()"><i class="fas fa-arrow-left"></i></div>
    <div class="header-title">Kirim WA Cepat</div>
    <div class="header-btn" onclick="location.reload()"><i class="fas fa-sync-alt"></i></div>
  </header>

  <div class="container">
    
    <div class="contact-tray">
        <div class="tray-header">
            <span class="tray-title"><i class="fas fa-address-book" style="color:var(--blue);"></i> Buku Kontak Hari Ini</span>
        </div>
        <div id="tempContactList" class="contact-list">
            </div>
    </div>

    <form id="waForm">
      
      <div class="step-card">
        <div class="step-badge">Langkah 1</div>
        <div class="form-group" style="margin-top: 20px;">
          <label>Mau Chat Siapa?</label>
          <input type="text" id="nama" class="input-modern" placeholder="Nama Pelanggan (Cth: Bpk. Jhon)">
        </div>
        <div class="form-group">
          <label>Nomor WhatsApp</label>
          <input type="tel" id="target" class="input-modern" placeholder="081234567890" required>
        </div>
        <button type="button" class="btn-save" onclick="saveCurrentContact()">
            <i class="fas fa-bookmark"></i> Simpan ke Buku Kontak Hari Ini
        </button>
      </div>

      <div class="step-card">
        <div class="step-badge">Langkah 2</div>
        <div class="form-group" style="margin-top: 20px;">
          <label>Pilih Jenis Pesan</label>
          <select id="template" class="input-modern" required>
            <option value="">-- Sentuh untuk memilih --</option>
            <option value="panduan">üìò Kirim Panduan & Akun</option>
            <option value="pemasangan">üõ†Ô∏è Konfirmasi Pemasangan Baru</option>
            <option value="maintenance">‚ö° Konfirmasi Perbaikan / MT</option>
            <option value="terminate">üö´ Info Cabut Perangkat</option>
          </select>
        </div>
      </div>

      <div id="guideFields" class="step-card hidden" style="border-color: var(--blue);">
        <div class="step-badge" style="background: #f59e0b; border-color:white;">Lengkapi Data</div>
        <div class="form-grid" style="margin-top: 20px;">
            <div class="form-group">
                <label>ID Pelanggan</label>
                <input type="text" id="idPel" class="input-modern" placeholder="ID12345">
            </div>
            <div class="form-group">
                <label>Sandi APK</label>
                <input type="text" id="sandi" class="input-modern" placeholder="654321">
            </div>
        </div>
        <div class="form-group">
            <label>Pilih Penanggung Jawab</label>
            <select id="pjSelect" class="input-modern">
                <option value="JAKA NUGRAHA - 085321525261">JAKA NUGRAHA</option>
                <option value="Achmed - 082130339580">Achmed</option>
                <option value="Alex - 082315919466">Alex</option>
                <option value="Anjar - 083134944914">Anjar</option>
                <option value="Chadika - 085175402270">Chadika</option>
                <option value="Deni - 083142076756">Deni</option>
                <option value="Gani - 089501960296">Gani</option>
                <option value="Gilang - 083829349013">Gilang</option>
                <option value="Lili - 082320215241">Lili</option>
                <option value="Uci - 081221500616">Uci</option>
                <option value="Romi Kantomi - 085860417890">Romi Kantomi</option>
                <option value="Soleh - 083837105050">Soleh</option>
                <option value="Taufik - 082321558345">Taufik</option>
                <option value="Firli - 083856525355">Firli</option>
                <option value="Delia - 088220333578">Delia</option>
                <option value="lainnya">-- Ketik Manual / Ambil Kontak HP --</option>
            </select>
            
            <div id="manualPJGroup" class="hidden" style="margin-top: 15px;">
                <input type="text" id="pjManual" class="input-modern" placeholder="Format: Nama - 08xxx">
                <button type="button" id="btnPickContact" class="btn-contact-hp">
                    <i class="far fa-address-book" style="color:var(--blue);"></i> Ambil Dari Buku Telepon HP
                </button>
            </div>
        </div>
      </div>

      <div class="step-card">
        <div class="step-badge" style="background: var(--primary); border-color:white;">Langkah 3</div>
        <div style="margin-top: 15px; text-align:center; font-weight:700; color:var(--text-muted); font-size:0.9rem;">
            Cek Pesan & Kirim
        </div>
        
        <div id="previewArea" class="wa-chat-container">
            <div class="wa-bubble" id="txtPreview"></div>
        </div>

        <button type="submit" class="btn-wa">
            <i class="fab fa-whatsapp" style="font-size: 1.4rem;"></i> BUKA WHATSAPP
        </button>
      </div>

    </form>
    
    <div style="text-align:center; font-size:0.75rem; color:#94a3b8; margin-top:20px;">
        Sistem Dispatcher Pintar ¬© 2026
    </div>
  </div>

  <script>
    // --- FITUR LOCAL STORAGE (Buku Kontak Anti Nyampur & Auto-Hapus Besok) ---
    let currentUser = JSON.parse(localStorage.getItem('ionUser')) || { email: 'guest' };

    function getTodayKey() {
        let d = new Date();
        return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`; 
    }

    function getStorageKey() {
        return `ion_wa_temp_${currentUser.email}`; 
    }

    function initContacts() {
        let storageKey = getStorageKey();
        let stored = localStorage.getItem(storageKey);
        let today = getTodayKey();
        
        if (stored) {
            let parsed = JSON.parse(stored);
            // CEK: Kalau ganti hari, hapus bersih!
            if (parsed.date !== today) {
                localStorage.removeItem(storageKey);
                renderContacts([]);
            } else {
                renderContacts(parsed.contacts);
            }
        } else {
            renderContacts([]);
        }
    }

    function saveCurrentContact() {
        let target = document.getElementById('target').value.trim();
        let nama = document.getElementById('nama').value.trim() || "Pelanggan";
        
        if(!target) return Swal.fire('Tunggu!', 'Isi dulu Nomor WhatsApp-nya di Langkah 1.', 'warning');

        let storageKey = getStorageKey();
        let today = getTodayKey();
        let stored = localStorage.getItem(storageKey);
        let contacts = [];

        if(stored) {
            let parsed = JSON.parse(stored);
            if(parsed.date === today) contacts = parsed.contacts;
        }

        if(!contacts.find(c => c.phone === target)) {
            contacts.push({ name: nama, phone: target });
            localStorage.setItem(storageKey, JSON.stringify({ date: today, contacts: contacts }));
            renderContacts(contacts);
            
            // Animasi berhasil yang ramah
            Swal.fire({
                icon: 'success', title: 'Tersimpan!', 
                text: 'Kontak ada di Buku Kontak atas. Besok akan hilang otomatis.', 
                timer: 2000, showConfirmButton: false
            });
            
            document.getElementById('target').value = '';
            document.getElementById('nama').value = '';
            updatePreview();
        } else {
            Swal.fire('Sudah Ada', 'Nomor ini sudah kamu simpan.', 'info');
        }
    }

    function renderContacts(contacts) {
        let container = document.getElementById('tempContactList');
        if(contacts.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#94a3b8; font-size:0.85rem; padding:15px; border:2px dashed #e2e8f0; border-radius:12px;">Belum ada kontak yang disimpan hari ini.</div>';
            return;
        }

        let html = '';
        contacts.forEach((c, index) => {
            html += `
            <div class="contact-item">
                <div class="c-info" onclick="loadContact('${c.phone}', '${c.name}')">
                    <div class="c-name">${c.name}</div>
                    <div class="c-phone"><i class="fab fa-whatsapp" style="color:#25d366;"></i> ${c.phone}</div>
                </div>
                <button type="button" class="btn-del-contact" onclick="deleteContact(${index})"><i class="fas fa-trash"></i></button>
            </div>`;
        });
        container.innerHTML = html;
    }

    function loadContact(phone, name) {
        document.getElementById('target').value = phone;
        if (name !== "Pelanggan") document.getElementById('nama').value = name;
        
        // Scroll otomatis ke Langkah 2 biar enak
        document.getElementById('template').scrollIntoView({behavior: 'smooth', block: 'center'});
        updatePreview();
    }

    function deleteContact(index) {
        let storageKey = getStorageKey();
        let stored = localStorage.getItem(storageKey);
        if(stored) {
            let parsed = JSON.parse(stored);
            parsed.contacts.splice(index, 1);
            localStorage.setItem(storageKey, JSON.stringify(parsed));
            renderContacts(parsed.contacts);
        }
    }

    // --- LOGIKA FORM ---
    const form = document.getElementById('waForm');
    const template = document.getElementById('template');
    const guideFields = document.getElementById('guideFields');
    const pjSelect = document.getElementById('pjSelect');
    const manualPJGroup = document.getElementById('manualPJGroup');
    const pjManual = document.getElementById('pjManual');
    const btnPickContact = document.getElementById('btnPickContact');
    const previewArea = document.getElementById('previewArea');
    const txtPreview = document.getElementById('txtPreview');

    template.addEventListener('change', () => {
        if (template.value === 'panduan') {
            guideFields.classList.remove('hidden');
        } else {
            guideFields.classList.add('hidden');
        }
        updatePreview();
    });

    pjSelect.addEventListener('change', () => {
        if (pjSelect.value === 'lainnya') {
            manualPJGroup.classList.remove('hidden');
        } else {
            manualPJGroup.classList.add('hidden');
        }
        updatePreview();
    });

    btnPickContact.addEventListener('click', async () => {
        if (!('contacts' in navigator && 'select' in navigator.contacts)) {
            Swal.fire('Fitur HP', 'Buka web ini lewat Google Chrome di HP Android untuk pakai fitur Ambil Kontak.', 'info');
            return;
        }
        try {
            const props = ['name', 'tel'];
            const opts = { multiple: false };
            const contact = await navigator.contacts.select(props, opts);
            if (contact.length > 0) {
                const name = contact[0].name ? contact[0].name[0] : "PJ";
                const phone = contact[0].tel ? contact[0].tel[0] : "";
                pjManual.value = `${name} - ${phone}`;
                updatePreview();
            }
        } catch (ex) { console.log("Gagal ambil kontak"); }
    });

    function updatePreview() {
        const type = template.value;
        if (!type) { 
            previewArea.style.display = 'none'; 
            return; 
        }

        let msg = "";
        const nama = document.getElementById('nama').value || "[Nama Pelanggan]";
        const id = document.getElementById('idPel').value || "[ID]";
        const sandi = document.getElementById('sandi').value || "[SANDI]";
        let pj = (pjSelect.value === 'lainnya') ? (pjManual.value || "[NAMA PJ]") : pjSelect.value;

        switch(type) {
            case 'panduan': msg = `Panduan Lengkap Pembayaran & Akun Ion Network\n\nYth. Bapak/Ibu ${nama},\n\nBerikut informasi akun WiFi Anda:\n- ID PELANGGAN : ${id}\n- SANDI APLIKASI : ${sandi}\n\nPanduan lengkap & cara bayar klik link di bawah:\nhttps://ionnetworksubang.github.io/Ion-network\n\nLink Aplikasi Member:\nhttps://play.google.com/store/apps/details?id=com.ionboardband.memberionapps\n\nPenanggung Jawab: ${pj}\n\nTerima kasih.`; break;
            case 'pemasangan': msg = `Assalamualaikum,\n\nSaya teknisi dari *ION NETWORK*. Ingin konfirmasi terkait jadwal pemasangan WiFi di lokasi Bapak/Ibu ${nama}.\n\nApakah hari ini bisa dilakukan proses instalasi? Terima kasih.`; break;
            case 'maintenance': msg = `Assalamualaikum,\n\nSaya teknisi dari *ION NETWORK*. Ingin konfirmasi terkait jadwal perbaikan/maintenance WiFi di lokasi Bapak/Ibu ${nama}.\n\nTerima kasih.`; break;
            case 'terminate': msg = `Assalamualaikum,\n\nSaya teknisi dari *ION NETWORK*. Ingin konfirmasi terkait jadwal pengambilan perangkat WiFi karena status berhenti berlangganan.\n\nTerima kasih.`; break;
        }

        txtPreview.innerText = msg;
        previewArea.style.display = 'block';
        return msg;
    }

    document.querySelectorAll('input, select').forEach(input => {
        input.addEventListener('input', updatePreview);
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        let target = document.getElementById('target').value.replace(/\D/g, ''); 
        if (target.startsWith('0')) target = '62' + target.substring(1);
        else if (!target.startsWith('62')) target = '62' + target;

        if (target.length < 10) { Swal.fire('Ups!', 'Isi Nomor Tujuan dengan benar di Langkah 1!', 'warning'); return; }
        if (!template.value) { Swal.fire('Ups!', 'Pilih jenis pesan di Langkah 2!', 'warning'); return; }

        const finalMsg = updatePreview();
        const waUrl = `https://wa.me/${target}?text=${encodeURIComponent(finalMsg)}`;
        window.open(waUrl, '_blank');
    });

    window.onload = () => {
      initContacts(); 
      updatePreview();
    };
  </script>

</body>
</html>